<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Graph Framework: Code Performance</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Graph Framework
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('code_performance.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Code Performance</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#code_performance_introduction">Introduction</a></li>
<li class="level1"><a href="#code_performance_scaling">Strong Scaling</a></li>
<li class="level1"><a href="#code_performance_comparison">Comparison to other Frameworks</a><ul><li class="level2"><a href="#code_performance_comparison_codes">Source codes for throughput benchmark comparison</a><ul><li class="level3"><a href="#code_performance_comparison_graph">Graph Framework</a></li>
<li class="level3"><a href="#code_performance_comparison_mlx">MLX</a></li>
<li class="level3"><a href="#code_performance_comparison_jaxx">JAX</a></li>
<li class="level3"><a href="#code_performance_comparison_kokkos">Kokkos</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>Benchmark cases for the graph framework.</p>
<h1><a class="anchor" id="code_performance_introduction"></a>
Introduction</h1>
<p>In this section we will look at the peformance of codes deveoped using this framework.</p>
<h1><a class="anchor" id="code_performance_scaling"></a>
Strong Scaling</h1>
<div class="image">
<img src="StrongScaling.png" alt=""/>
<div class="caption">
Left: Strong scaling wall time for 100000 Rays traced in a realistic tokamak equilibrium. Right: Strong scaling speedup normalized to the wall time for a single device or core. The dashed diagonal line references the best possible scaling. The M2 Max has 8 fast performance cores and 4 slower energy efficiency cores resulting drop off in improvement beyond 8 cores.</div></div>
<p> To benchmark code performance we traced \(10^{6}\) rays for \(10^{3}\) timesteps using the cold plasma dispersion relation in a realistic tokamak equilibrium. The figure above shows the strong scaling of wall time as the number of GPU and CPU devices are increased. The figure above shows the strong scaling speed up </p><p class="formulaDsp">
\begin{equation}SpeedUp = \frac{time\left(1\right)}{time\left(n\right)}\end{equation}
</p>
<p> Benchmarking was prepared on two different setups.</p>
<p>The first set up as a Mac Studio with an Apple M2 Max chip. The M2 chip contains a 12 core CPU where 8 cores are faster performance codes and the remaining 4 are slower efficiency cores. The M2 Max also contains a single 38-core GPU which only support single precision operations. The second setup is a server with 4 Nvidia A100 GPUs. Benchmarking measures the time to trace \(10^{6}\) rays but does not include the setup and JIT times.</p>
<p>The figure above shows the advantage even a single GPU has over CPU execution. In single precision, the M2's GPU is almost \(100\times\) faster a single CPU core while the a single A100 has a nearly $800\times$ advantage. An interesting thing to note is the M2 Max CPU show no advantage between single and double precision execution.</p>
<p>For large problem sizes the framework is expected to show good scaling with number of devices as the problems we are applying are embarrassingly parallel in nature. The figure above shows the strong scaling speed up with the number of devices. The framework shows good strong scaling as the problem is split among more devices. The architecture of the M2 Chip contains 8 fast performance cores and 4 slower energy efficiency cores. This produces a noticeable knee in the scaling after 8 core are used. Overall, the framework demonstrates good scaling across CPU and GPU devices.</p>
<h1><a class="anchor" id="code_performance_comparison"></a>
Comparison to other Frameworks</h1>
<div class="image">
<img src="Comparison.png" alt=""/>
<div class="caption">
Particle throughput for graph framework compared to MLX and JAX.</div></div>
<p> To benchmark against other frameworks we will look at the simple case of gyro motion in a uniform magnetic field \(\vec{B}=B_{0}\hat{z}\). </p><p class="formulaDsp">
\begin{equation}\frac{\partial\vec{v}}{\partial t} = dt\vec{v}\times\vec{B}\end{equation}
</p>
 <p class="formulaDsp">
\begin{equation}\frac{\partial\vec{x}}{\partial t} = dt\vec{v}\end{equation}
</p>
<p>We compared the graph framework against the <a href="https://ml-explore.github.io/mlx/build/html/index.html">MLX</a> framework since it supports Apple GPUs, <a href="https://docs.jax.dev/en/latest/">JAX</a> due to it's popularity, and <a href="https://kokkos.org">Kokkos</a> for its performance portability. Source codes for this benchmark case is available in the appendix. Figure fig:compare} shows the through put of pushing $10^{8}$ particles for $10^{3}$ time steps. The graph framework consistently shows the best throughput on both CPUs and GPUs. Note MLX CPU throughput could by improved by splitting the problem to multiple threads.</p>
<h2><a class="anchor" id="code_performance_comparison_codes"></a>
Source codes for throughput benchmark comparison</h2>
<h3><a class="anchor" id="code_performance_comparison_graph"></a>
Graph Framework</h3>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> size = 100000000;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> steps = 1000;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_devices = <a class="code hl_function" href="classjit_1_1context.html#a2d04d789825a5f04206a3d4d7765b930">jit::context&lt;float&gt;::max_concurrency</a>();</div>
<div class="line">std::vector&lt;std::thread&gt;</div>
<div class="line">    threads(std::max(std::min(num_devices),</div>
<div class="line">                     <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span><span class="keyword">&gt;</span> (size)),</div>
<div class="line">            <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span><span class="keyword">&gt;</span> (1)));</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> batch = size/threads.size();</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> extra = size%threads.size();</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classtiming_1_1measure__diagnostic__threaded.html">timing::measure_diagnostic_threaded</a> time_steps(<span class="stringliteral">&quot;Time Steps&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0, ie = threads.size(); i &lt; ie; i++) {</div>
<div class="line">    threads[i] =</div>
<div class="line">        std::thread([batch, extra,</div>
<div class="line">                     &amp;time_steps] (<span class="keyword">const</span> <span class="keywordtype">size_t</span> thread_number) -&gt; <span class="keywordtype">void</span> {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">size_t</span> local_size = batch + (extra &gt; thread_number ? 1 : 0);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">auto</span> x = <a class="code hl_function" href="namespacegraph.html#a2b36a8e136f4187b4de7e2e31a3e4168">graph::variable&lt;float&gt;</a> (local_size, 0.0, <span class="stringliteral">&quot;x&quot;</span>);</div>
<div class="line">        <span class="keyword">auto</span> y = <a class="code hl_function" href="namespacegraph.html#a2b36a8e136f4187b4de7e2e31a3e4168">graph::variable&lt;float&gt;</a> (local_size, 0.0, <span class="stringliteral">&quot;y&quot;</span>);</div>
<div class="line">        <span class="keyword">auto</span> z = <a class="code hl_function" href="namespacegraph.html#a2b36a8e136f4187b4de7e2e31a3e4168">graph::variable&lt;float&gt;</a> (local_size, 0.0, <span class="stringliteral">&quot;z&quot;</span>);</div>
<div class="line">            </div>
<div class="line">        <span class="keyword">auto</span> vx = <a class="code hl_function" href="namespacegraph.html#a2b36a8e136f4187b4de7e2e31a3e4168">graph::variable&lt;float&gt;</a> (local_size, 1.0, <span class="stringliteral">&quot;vx&quot;</span>);</div>
<div class="line">        <span class="keyword">auto</span> vy = <a class="code hl_function" href="namespacegraph.html#a2b36a8e136f4187b4de7e2e31a3e4168">graph::variable&lt;float&gt;</a> (local_size, 0.0, <span class="stringliteral">&quot;vy&quot;</span>);</div>
<div class="line">        <span class="keyword">auto</span> vz = <a class="code hl_function" href="namespacegraph.html#a2b36a8e136f4187b4de7e2e31a3e4168">graph::variable&lt;float&gt;</a> (local_size, 1.0, <span class="stringliteral">&quot;vz&quot;</span>);</div>
<div class="line">            </div>
<div class="line">        <span class="keyword">auto</span> b = <a class="code hl_function" href="namespacegraph.html#a2b36a8e136f4187b4de7e2e31a3e4168">graph::vector&lt;float&gt;</a> (0.0, 0.0, 1.0);</div>
<div class="line">        <span class="keyword">auto</span> v = <a class="code hl_function" href="namespacegraph.html#a72ad164d0058aef2543cf1e138250202">graph::vector</a>(vx, vy, vz);</div>
<div class="line">        <span class="keyword">auto</span> pos = <a class="code hl_function" href="namespacegraph.html#a72ad164d0058aef2543cf1e138250202">graph::vector</a>(x, y, z);</div>
<div class="line">            </div>
<div class="line">        <span class="keyword">auto</span> lorentz = v-&gt;cross(b);</div>
<div class="line">        <span class="keyword">auto</span> dt = <a class="code hl_function" href="namespacegraph.html#a2b36a8e136f4187b4de7e2e31a3e4168">graph::constant&lt;float&gt;</a> (0.000001);</div>
<div class="line">            </div>
<div class="line">        <span class="keyword">auto</span> v_next = v + dt*lorentz;</div>
<div class="line">        <span class="keyword">auto</span> pos_next = pos + dt*v_next;</div>
<div class="line">            </div>
<div class="line">        <a class="code hl_class" href="classworkflow_1_1manager.html">workflow::manager&lt;float&gt;</a> work(thread_number);</div>
<div class="line">        work.add_item({</div>
<div class="line">            <a class="code hl_function" href="namespacegraph.html#a9321a15c96554d065da2ffe49e969ff4">graph::variable_cast</a>(x),</div>
<div class="line">            <a class="code hl_function" href="namespacegraph.html#a9321a15c96554d065da2ffe49e969ff4">graph::variable_cast</a>(y),</div>
<div class="line">            <a class="code hl_function" href="namespacegraph.html#a9321a15c96554d065da2ffe49e969ff4">graph::variable_cast</a>(z),</div>
<div class="line">            <a class="code hl_function" href="namespacegraph.html#a9321a15c96554d065da2ffe49e969ff4">graph::variable_cast</a>(vx),</div>
<div class="line">            <a class="code hl_function" href="namespacegraph.html#a9321a15c96554d065da2ffe49e969ff4">graph::variable_cast</a>(vy),</div>
<div class="line">            <a class="code hl_function" href="namespacegraph.html#a9321a15c96554d065da2ffe49e969ff4">graph::variable_cast</a>(vz)</div>
<div class="line">        }, {}, {</div>
<div class="line">            {pos_next-&gt;get_x(), <a class="code hl_function" href="namespacegraph.html#a9321a15c96554d065da2ffe49e969ff4">graph::variable_cast</a>(x)},</div>
<div class="line">            {pos_next-&gt;get_y(), <a class="code hl_function" href="namespacegraph.html#a9321a15c96554d065da2ffe49e969ff4">graph::variable_cast</a>(y)},</div>
<div class="line">            {pos_next-&gt;get_z(), <a class="code hl_function" href="namespacegraph.html#a9321a15c96554d065da2ffe49e969ff4">graph::variable_cast</a>(z)},</div>
<div class="line">            {v_next-&gt;get_x(), <a class="code hl_function" href="namespacegraph.html#a9321a15c96554d065da2ffe49e969ff4">graph::variable_cast</a>(vx)},</div>
<div class="line">            {v_next-&gt;get_y(), <a class="code hl_function" href="namespacegraph.html#a9321a15c96554d065da2ffe49e969ff4">graph::variable_cast</a>(vy)},</div>
<div class="line">            {v_next-&gt;get_z(), <a class="code hl_function" href="namespacegraph.html#a9321a15c96554d065da2ffe49e969ff4">graph::variable_cast</a>(vz)}</div>
<div class="line">        }, NULL, <span class="stringliteral">&quot;Lorentz_kernel&quot;</span>, local_size);</div>
<div class="line">        work.compile();</div>
<div class="line">            </div>
<div class="line">        time_steps.start_time(thread_number);</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j = 0; j &lt; steps; j++) {</div>
<div class="line">            work.run();</div>
<div class="line">        }</div>
<div class="line">        work.wait();</div>
<div class="line">        time_steps.end_time(thread_number);</div>
<div class="line">    }, <a class="code hl_variable" href="namespacegraph.html#a9b84f5a5f048fe7931dc4f9d39f5efa6">i</a>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (std::thread &amp;t : threads) {</div>
<div class="line">    t.join();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">time_steps.print_max();</div>
<div class="ttc" id="aclassjit_1_1context_html_a2d04d789825a5f04206a3d4d7765b930"><div class="ttname"><a href="classjit_1_1context.html#a2d04d789825a5f04206a3d4d7765b930">jit::context::max_concurrency</a></div><div class="ttdeci">static size_t max_concurrency()</div><div class="ttdoc">Get the maximum number of concurrent instances.</div><div class="ttdef"><b>Definition</b> jit.hpp:85</div></div>
<div class="ttc" id="aclasstiming_1_1measure__diagnostic__threaded_html"><div class="ttname"><a href="classtiming_1_1measure__diagnostic__threaded.html">timing::measure_diagnostic_threaded</a></div><div class="ttdoc">A timing object that averages over multiple threads.</div><div class="ttdef"><b>Definition</b> timing.hpp:67</div></div>
<div class="ttc" id="aclassworkflow_1_1manager_html"><div class="ttname"><a href="classworkflow_1_1manager.html">workflow::manager</a></div><div class="ttdoc">Class representing a workflow manager.</div><div class="ttdef"><b>Definition</b> workflow.hpp:171</div></div>
<div class="ttc" id="anamespacegraph_html_a2b36a8e136f4187b4de7e2e31a3e4168"><div class="ttname"><a href="namespacegraph.html#a2b36a8e136f4187b4de7e2e31a3e4168">graph::zero</a></div><div class="ttdeci">constexpr shared_leaf&lt; T, SAFE_MATH &gt; zero()</div><div class="ttdoc">Forward declare for zero.</div><div class="ttdef"><b>Definition</b> node.hpp:995</div></div>
<div class="ttc" id="anamespacegraph_html_a72ad164d0058aef2543cf1e138250202"><div class="ttname"><a href="namespacegraph.html#a72ad164d0058aef2543cf1e138250202">graph::vector</a></div><div class="ttdeci">shared_vector&lt; T, SAFE_MATH &gt; vector(shared_leaf&lt; T, SAFE_MATH &gt; x, shared_leaf&lt; T, SAFE_MATH &gt; y, shared_leaf&lt; T, SAFE_MATH &gt; z)</div><div class="ttdoc">Build a shared vector quantity.</div><div class="ttdef"><b>Definition</b> vector.hpp:133</div></div>
<div class="ttc" id="anamespacegraph_html_a9321a15c96554d065da2ffe49e969ff4"><div class="ttname"><a href="namespacegraph.html#a9321a15c96554d065da2ffe49e969ff4">graph::variable_cast</a></div><div class="ttdeci">shared_variable&lt; T, SAFE_MATH &gt; variable_cast(shared_leaf&lt; T, SAFE_MATH &gt; x)</div><div class="ttdoc">Cast to a variable node.</div><div class="ttdef"><b>Definition</b> node.hpp:1747</div></div>
<div class="ttc" id="anamespacegraph_html_a9b84f5a5f048fe7931dc4f9d39f5efa6"><div class="ttname"><a href="namespacegraph.html#a9b84f5a5f048fe7931dc4f9d39f5efa6">graph::i</a></div><div class="ttdeci">constexpr T i</div><div class="ttdoc">Convenience type for imaginary constant.</div><div class="ttdef"><b>Definition</b> node.hpp:1027</div></div>
</div><!-- fragment --><h3><a class="anchor" id="code_performance_comparison_mlx"></a>
MLX</h3>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">const</span> std::vector&lt;mlx::core::array&gt; &amp;inputs;</div>
<div class="line"><span class="keyword">typedef</span> std::vector&lt;mlx::core::array&gt; outputs;</div>
<div class="line"><span class="keyword">typedef</span> std::function&lt;outputs(inputs)&gt; function;</div>
<div class="line"> </div>
<div class="line">mlx::core::set_default_device(mlx::core::Device::gpu);</div>
<div class="line"> </div>
<div class="line">function push = mlx::core::compile([](inputs in) -&gt; outputs {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> dt = 0.000001;</div>
<div class="line">    <span class="keyword">const</span> mlx::core::array zero = mlx::core::zeros({1});</div>
<div class="line">    <span class="keyword">const</span> mlx::core::array one = mlx::core::zeros({1});</div>
<div class="line">    <span class="keyword">const</span> mlx::core::array vx_next = in[3] + dt*(in[4]*<a class="code hl_function" href="namespacegraph.html#a766709630ad76ecd13abcae8880fc820">one</a> - in[5]*<a class="code hl_function" href="namespacegraph.html#a2b36a8e136f4187b4de7e2e31a3e4168">zero</a>);</div>
<div class="line">    <span class="keyword">const</span> mlx::core::array vy_next = in[4] + dt*(in[5]*<a class="code hl_function" href="namespacegraph.html#a2b36a8e136f4187b4de7e2e31a3e4168">zero</a> - in[3]*<a class="code hl_function" href="namespacegraph.html#a766709630ad76ecd13abcae8880fc820">one</a>);</div>
<div class="line">    <span class="keyword">const</span> mlx::core::array vz_next = in[5] + dt*(in[3]*<a class="code hl_function" href="namespacegraph.html#a2b36a8e136f4187b4de7e2e31a3e4168">zero</a> - in[4]*<a class="code hl_function" href="namespacegraph.html#a2b36a8e136f4187b4de7e2e31a3e4168">zero</a>);</div>
<div class="line">    <span class="keyword">const</span> mlx::core::array x_next = in[0] + dt*vx_next;</div>
<div class="line">    <span class="keyword">const</span> mlx::core::array y_next = in[1] + dt*vy_next;</div>
<div class="line">    <span class="keyword">const</span> mlx::core::array z_next = in[2] + dt*vz_next;</div>
<div class="line">    <span class="keywordflow">return</span> {x_next, y_next, z_next, vx_next, vy_next, vz_next};</div>
<div class="line">});</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> size = 100000000;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> steps = 1000;</div>
<div class="line"> </div>
<div class="line">mlx::core::array x = mlx::core::zeros({size});</div>
<div class="line">mlx::core::array y = mlx::core::zeros({size});</div>
<div class="line">mlx::core::array z = mlx::core::zeros({size});</div>
<div class="line">mlx::core::array vx = mlx::core::ones({size});</div>
<div class="line">mlx::core::array vy = mlx::core::zeros({size});</div>
<div class="line">mlx::core::array vz = mlx::core::ones({size});</div>
<div class="line">outputs in = {x, y, z, vx, vy, vz};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> std::chrono::high_resolution_clock::time_point start = std::chrono::high_resolution_clock::now();</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0; <a class="code hl_variable" href="namespacegraph.html#a9b84f5a5f048fe7931dc4f9d39f5efa6">i</a> &lt; steps; <a class="code hl_variable" href="namespacegraph.html#a9b84f5a5f048fe7931dc4f9d39f5efa6">i</a>++) {</div>
<div class="line">    in = push(in);</div>
<div class="line">    <span class="keywordflow">for</span> (mlx::core::array &amp;i : in) {</div>
<div class="line">        <a class="code hl_variable" href="namespacegraph.html#a9b84f5a5f048fe7931dc4f9d39f5efa6">i</a>.eval();</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">std::chrono::high_resolution_clock::time_point end = std::chrono::high_resolution_clock::now();</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> total_time = end - start;</div>
<div class="ttc" id="anamespacegraph_html_a766709630ad76ecd13abcae8880fc820"><div class="ttname"><a href="namespacegraph.html#a766709630ad76ecd13abcae8880fc820">graph::one</a></div><div class="ttdeci">constexpr shared_leaf&lt; T, SAFE_MATH &gt; one()</div><div class="ttdoc">Forward declare for one.</div><div class="ttdef"><b>Definition</b> node.hpp:1008</div></div>
</div><!-- fragment --><h3><a class="anchor" id="code_performance_comparison_jaxx"></a>
JAX</h3>
<div class="fragment"><div class="line">def push(x, y, z, vx, vy, vz):</div>
<div class="line">    dt = 0.000001</div>
<div class="line">    vx_next = vx + dt*(vy*1 - vz*0)</div>
<div class="line">    vy_next = vy + dt*(vz*0 - vx*1)</div>
<div class="line">    vz_next = vz + dt*(vx*0 - vy*0)</div>
<div class="line">    return vx_next, vy_next, vz_next,</div>
<div class="line">           x + dt*vx_next, y + dt*vy_next, z + dt*vz_next</div>
<div class="line"> </div>
<div class="line">push_jit = jax.<a class="code hl_namespace" href="namespacejit.html">jit</a>(push)</div>
<div class="line"> </div>
<div class="line">size = 100000000</div>
<div class="line">steps = 1000</div>
<div class="line"> </div>
<div class="line">x = jax.numpy.zeros((size))</div>
<div class="line">y = jax.numpy.zeros((size))</div>
<div class="line">z = jax.numpy.zeros((size))</div>
<div class="line">vx = jax.numpy.ones((size))</div>
<div class="line">vy = jax.numpy.zeros((size))</div>
<div class="line">vz = jax.numpy.ones((size))</div>
<div class="line"> </div>
<div class="line">start = time.time()</div>
<div class="line">for i in range(0, steps):</div>
<div class="line">    x, y, z, vx, vy, vz = push_jit(x, y, z, vx, vy, vz)</div>
<div class="line">jax.block_until_ready([x, y, z, vx, vy, vz])</div>
<div class="line">end = time.time()</div>
<div class="line"> </div>
<div class="line">print(end - start)</div>
<div class="ttc" id="anamespacejit_html"><div class="ttname"><a href="namespacejit.html">jit</a></div><div class="ttdoc">Name space for JIT functions.</div><div class="ttdef"><b>Definition</b> jit.hpp:41</div></div>
</div><!-- fragment --><h3><a class="anchor" id="code_performance_comparison_kokkos"></a>
Kokkos</h3>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> size = 100000000;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> steps = 1000;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">using </span>ViewVectorType = Kokkos::View&lt;float *, Kokkos::SharedSpace&gt;;</div>
<div class="line">ViewVectorType x(<span class="stringliteral">&quot;x&quot;</span>, size);</div>
<div class="line">ViewVectorType y(<span class="stringliteral">&quot;y&quot;</span>, size);</div>
<div class="line">ViewVectorType z(<span class="stringliteral">&quot;z&quot;</span>, size);</div>
<div class="line"> </div>
<div class="line">ViewVectorType vx(<span class="stringliteral">&quot;vx&quot;</span>, size);</div>
<div class="line">ViewVectorType vy(<span class="stringliteral">&quot;vy&quot;</span>, size);</div>
<div class="line">ViewVectorType vz(<span class="stringliteral">&quot;vz&quot;</span>, size);</div>
<div class="line"> </div>
<div class="line">Kokkos::parallel_for(size, KOKKOS_LAMBDA(<span class="keyword">const</span> int64_t index) {</div>
<div class="line">    vx[index] = 1;</div>
<div class="line">    vz[index] = 1;</div>
<div class="line">});</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> std::chrono::high_resolution_clock::time_point start = std::chrono::high_resolution_clock::now();</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; steps; i++) {</div>
<div class="line">    Kokkos::parallel_for(size, KOKKOS_LAMBDA(<span class="keyword">const</span> int64_t index) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> dt = 0.000001;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> vx_next = vx[index] + dt*(vy[index]*1 - vz[index]*0);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> vy_next = vy[index] + dt*(vz[index]*0 - vx[index]*1);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> vz_next = vz[index] + dt*(vx[index]*0 - vy[index]*0);</div>
<div class="line">        x[index] += dt*vx_next;</div>
<div class="line">        y[index] += dt*vy_next;</div>
<div class="line">        z[index] += dt*vz_next;</div>
<div class="line">        vx[index] = vx_next;</div>
<div class="line">        vy[index] = vy_next;</div>
<div class="line">        vz[index] = vz_next;</div>
<div class="line">    });</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">Kokkos::fence();</div>
<div class="line"> </div>
<div class="line">std::chrono::high_resolution_clock::time_point end = std::chrono::high_resolution_clock::now();</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> total_time = end - start;</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
